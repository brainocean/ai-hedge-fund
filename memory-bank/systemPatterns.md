# AI Hedge Fund - 系统架构模式

## 整体架构

### 多智能体协作架构
```
┌─────────────────────────────────────────────────────────────┐
│                    AI Hedge Fund System                     │
├─────────────────────────────────────────────────────────────┤
│  投资大师智能体层 (Investment Masters Layer)                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │Warren Buffett│ │Charlie Munger│ │Ben Graham  │  ... (11) │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
├─────────────────────────────────────────────────────────────┤
│  分析智能体层 (Analysis Agents Layer)                       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │Fundamentals │ │Technicals   │ │Sentiment    │  ... (4)  │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
├─────────────────────────────────────────────────────────────┤
│  管理智能体层 (Management Layer)                            │
│  ┌─────────────┐ ┌─────────────┐                           │
│  │Risk Manager │ │Portfolio Mgr│                           │
│  └─────────────┘ └─────────────┘                           │
├─────────────────────────────────────────────────────────────┤
│  数据层 (Data Layer)                                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │Financial API│ │Cache System │ │State Mgmt   │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
```

## 核心设计模式

### 1. 智能体模式 (Agent Pattern)
- **基础智能体类**: 所有智能体继承自基础类
- **统一接口**: 标准化的分析和决策接口
- **个性化实现**: 每个智能体有独特的投资哲学和逻辑

### 2. 状态管理模式 (State Management)
- **集中状态**: 使用LangGraph管理全局状态
- **状态传递**: 智能体间通过状态对象传递信息
- **状态持久化**: 支持状态的保存和恢复

### 3. 管道模式 (Pipeline Pattern)
```
数据获取 → 预处理 → 智能体分析 → 决策聚合 → 风险管理 → 最终决策
```

### 4. 策略模式 (Strategy Pattern)
- **LLM策略**: 支持多种LLM提供商 (OpenAI, Groq, Ollama等)
- **数据策略**: 支持不同数据源的切换
- **分析策略**: 不同类型的分析方法

## 关键组件架构

### 智能体系统
```python
# 智能体基类模式
class BaseAgent:
    def __init__(self, llm_config, name):
        self.llm = self._initialize_llm(llm_config)
        self.name = name
    
    def analyze(self, state: HedgeFundState) -> dict:
        # 标准分析接口
        pass
    
    def _get_prompt(self) -> str:
        # 个性化提示词
        pass
```

### 状态管理
```python
# 状态对象模式
@dataclass
class HedgeFundState:
    ticker: str
    data: dict
    analysis_results: dict
    decisions: list
    portfolio: dict
    risk_metrics: dict
```

### 数据层架构
- **缓存层**: 减少API调用，提高性能
- **数据模型**: 标准化的数据结构
- **API抽象**: 统一的数据获取接口

## 技术决策

### 1. LangGraph选择
- **原因**: 专为多智能体系统设计
- **优势**: 状态管理、流程控制、可视化
- **权衡**: 学习曲线vs功能完整性

### 2. 模块化设计
- **智能体独立**: 每个智能体可独立开发和测试
- **接口标准化**: 统一的输入输出格式
- **可扩展性**: 易于添加新的智能体

### 3. 配置驱动
- **环境配置**: 通过.env文件管理API密钥
- **模型配置**: JSON文件管理LLM配置
- **智能体配置**: 可配置的智能体参数

## 数据流模式

### 分析流程
1. **数据获取**: 从Financial Datasets API获取股票数据
2. **数据预处理**: 清洗和格式化数据
3. **并行分析**: 多个智能体同时分析
4. **结果聚合**: 收集所有智能体的分析结果
5. **风险评估**: 风险管理智能体评估风险
6. **投资组合优化**: 投资组合管理智能体做最终决策

### 错误处理模式
- **重试机制**: API调用失败时的重试逻辑
- **降级策略**: 主要服务不可用时的备选方案
- **错误传播**: 结构化的错误信息传递

## 扩展点

### 新智能体集成
1. 继承BaseAgent类
2. 实现analyze方法
3. 定义个性化提示词
4. 注册到系统中

### 新数据源集成
1. 实现数据源接口
2. 添加数据转换逻辑
3. 更新缓存策略
4. 配置API访问

### 新LLM提供商集成
1. 实现LLM接口
2. 添加配置选项
3. 更新模型选择逻辑
4. 测试兼容性

## 性能优化模式

### 缓存策略
- **数据缓存**: 缓存股票数据减少API调用
- **结果缓存**: 缓存分析结果避免重复计算
- **智能失效**: 基于时间和数据变化的缓存失效

### 并发处理
- **智能体并行**: 多个智能体可并行分析
- **异步IO**: 异步处理API调用
- **资源池**: LLM连接池管理

### 内存管理
- **状态清理**: 及时清理不需要的状态数据
- **对象复用**: 重用可复用的对象
- **内存监控**: 监控内存使用情况
